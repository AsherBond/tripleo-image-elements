#!/bin/bash
set -eux

PATH=/usr/local/bin:$PATH
source /root/stackrc

PUBLIC_INTERFACE=$(os-config-applier --key quantum.ovs.public_interface)

if ! grep -q boot-stack /etc/network/interfaces && ! grep -q "iface $PUBLIC_INTERFACE" /etc/network/interfaces; then
  cat >> /etc/network/interfaces <<eof

# This interface was installed by the diskimage-builder boot-stack element.
auto $PUBLIC_INTERFACE
iface $PUBLIC_INTERFACE inet static
  address 192.0.2.1
  netmask 255.255.255.0
  up iptables -t nat -A PREROUTING -d 169.254.169.254 -p tcp -m tcp --dport 80 -j REDIRECT --to-port 8775
  up iptables -t nat -A POSTROUTING  -s 192.0.2.0/24 -o eth0 -j MASQUERADE
  up ip addr add 192.0.2.33/29 dev $PUBLIC_INTERFACE

# Public Bridge
#    auto eth2
#    iface eth2 inet manual
#    up ifconfig \$IFACE 0.0.0.0 up
#    up ip link set \$IFACE promisc on
#    down ifconfig \$IFACE down
eof
elif ! grep -q '# may need to add' /etc/network/interfaces ; then
    echo "# may need to add 192.0.2.1 to $PUBLIC_INTERFACE, see $0" >> /etc/network/interfaces
fi

service networking restart

OVS_PHYSICAL_BRIDGE=br-ctlplane
PHYSICAL_NETWORK=ctlplane

init-quantum-ovs

service quantum-server restart

# TODO: configurable
ALLOCATION_POOL="start=192.0.2.34,end=192.0.2.38"
NETWORK_GATEWAY=192.0.2.33
FIXED_RANGE=192.0.2.33/29
TENANT_ID=$(keystone tenant-list | grep ' admin ' | awk '{print $2}')

NET_ID=$(quantum net-create $PHYSICAL_NETWORK --tenant_id $TENANT_ID --provider:network_type flat --provider:physical_network "$PHYSICAL_NETWORK" | grep ' id ' | awk '{print $4}')
SUBNET_ID=$(quantum subnet-create --tenant_id $TENANT_ID --ip_version 4 ${ALLOCATION_POOL:+--allocation-pool $ALLOCATION_POOL} --gateway $NETWORK_GATEWAY $NET_ID $FIXED_RANGE | grep ' id ' | awk '{print $4}')

ifconfig $OVS_PHYSICAL_BRIDGE up
