#!/bin/bash
set -eu


function install_upstart {
  local name=$1
  local user=$2
  local cmd=$3
  shift; shift; shift
  local args=$*
  cat > /etc/init/$name.conf <<EOF
start on runlevel [2345]
stop on runlevel [016]

pre-start script
  mkdir -p /var/run/$user
  chown -R $user:$user /var/run/$user
end script

respawn

exec start-stop-daemon --start -c $user --exec /opt/stack/venvs/$user/bin/$cmd -- $args

# Help avoid race with daemon listening. http://pad.lv/1179766
post-start exec sleep 1
EOF
}

function install_systemd {
  local name=$1
  local user=$2
  local cmd=$3
  shift; shift; shift
  local args=$*
  cat > /etc/systemd/system/$name.service <<EOF
[Unit]
Description=$name Service

[Service]
ExecStart=/opt/stack/venvs/$user/bin/$cmd -- $args
User=$user

[Install]
WantedBy=multi-user.target
Alias=$name.service
EOF
}

if [ $# -lt 3 ]; then
  echo "Usage: os-svc-daemon DAEMON_NAME USER COMMAND [ARG[ARG[...]]]"
  exit 1
fi

# TODO: SysV init fallback support
if [ -d /etc/init ]; then
  install_upstart $*
elif [ -d /etc/systemd/system ]; then
  install_systemd $*
fi
